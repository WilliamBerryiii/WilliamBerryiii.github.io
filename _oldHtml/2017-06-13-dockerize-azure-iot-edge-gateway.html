---
layout: post
title: Dockerize the Azure IoT-Edge Gateway
date: '2017-06-13T16:59:00.002-07:00'
author: William Berry
tags:
- Azure Iot Hub
- Containers
- Docker
- IoT-Edge
- Azure IoT Gateway SDK
modified_time: '2017-06-13T16:59:26.953-07:00'
blogger_id: tag:blogger.com,1999:blog-4707687462195457004.post-6933621790343635894
blogger_orig_url: http://www.lucidmotions.net/2017/06/dockerize-azure-iot-edge-gateway.html
---

Like most developers in the IoT space, I write code that is typically destined for Linux run-times; but I spend my days typing away on a Surface Book running Windows. &nbsp;In days past, when I needed to do some hacking, I'd fire up a Raspberry PI or jump over onto one of a few Ubuntu VMs running HyperV sucking up disk space, processor time and RAM. &nbsp;Thankfully, technology has progressed and these days, with Docker being all the rage, I just spin up a container and get to work.<br /><br />One of my common tasks has been developing workflow modules for Azure IoT-Edge, our open source IoT gateway. &nbsp;These modules provide functionality like data compression, aggregation, protocol translation, etc. &nbsp;Easily spinning up a consistent development environment has been critical to accelerating this work, so I figured I'd share the love and show you how to get the gateway up and running in a Linux container on your Windows box using Docker.<br /><br />Step one is installing Docker on your Windows 10 (Anniversary edition or higher). &nbsp;Docker provides great <a href="https://docs.docker.com/docker-for-windows/install/">setup instructions</a> that will walk you through that whole process. &nbsp;Though you can switch to using "Windows Containers" in the Docker settings, let's leave it with the default "Linux Container" setting. &nbsp;With Docker installed, check and make sure everything is working properly by issuing:<br /><br />`docker version`<br /><br />in an elevated Powershell prompt. &nbsp;This command should return data for both the client and server. &nbsp;If it doesn't ... there are a copious number of fixes blogged about across the web. &nbsp;I've also found that just selecting "Restore Docker" from the Docker Settings pane to be a useful nuke option.<br /><br />Head over to the Azure Portal and set up a "Free" tier IoT Hub. &nbsp;Use the integrated device manager to add two test devices, select 'Symetric Keys' and have them auto-generated. &nbsp;Record the device names and primary keys for use in our dockerfile.<br /><br />Now create a folder that we can put a dockerfile into. &nbsp;`mkdir iot-edge-container` sounds nice.<br /><br />`cd` into the directory and create a text file called `dockerfile.txt`.<br /><br />The first step with our dockerfile will be to declare the base OS we want to use for the image. &nbsp;In this case we'll do Ubuntu:<br /><br />`FROM ubuntu`<br /><br />Boy that was super hard; glad we got it out of the way. <br /><br />Next we'll need to add some environment variables to the image. &nbsp;There are a thousand secure ways to do this other than putting our secretes into our dockerfile; but time is of the essence, and that was a disclaimer to encourage you to do the right thing. &nbsp;Please <a href="https://blog.docker.com/2017/02/docker-secrets-management/">see here </a>for detailed options from Docker. &nbsp;So onto those env vars:<br /><br />```<br /># ENV vars for setup<br />ENV IoTHubName {iot_hub_name}<br />ENV IoTHubSuffix azure-devices.net <br />ENV device1 {device1_name}<br />ENV device1key {device1_key}<br />ENV device2 {device2_name}<br />ENV device2key {device2_key}<br />```<br /><br />With the environment variables set up, we need to now make sure that the base image is up-to-date and all the IoT-Edge project dependencies are installed. &nbsp;Apt-Get will be our friend ...<br /><br />```<br /># Update image<br />RUN apt-get update<br />RUN apt-get --assume-yes install curl build-essential libcurl4-openssl-dev git cmake pkg-config libssl-dev uuid-dev valgrind jq libglib2.0-dev libtool autoconf autogen vim<br />```<br /><br />Please take note that I've intentionally started a flame war by installing vim ... I have a hard enough time exiting vim, so emacs is off the table completely. &nbsp;Also note that we are installing `jq` - this will be used to dynamically populate the Gateway's simulator JSON config file.<br /><br />With the image all updated, we can turn our attention to cloning the IoT-Edge repository and kicking off the build:<br /><br />```<br /># Checkout code<br />WORKDIR /usr/src/app<br />RUN git clone https://github.com/Azure/iot-edge.git<br /><br /># Build<br />WORKDIR /usr/src/app/iot-edge/tools<br />RUN ./build.sh --disable-native-remote-modules<br />```<br /><br />Take note of the flag on the build script, this may or may not be necessary depending on the base OS you are using. &nbsp;Since we are running on Ubuntu, this flag will keep libuv from blowing up during the build.<br /><br />Finally, we can turn our attention to getting the container run-time commands all ready. &nbsp;The following big block of code will get us into the right directory to modify the json config file, echo the config to the console to make sure it's all correct and then kick off the Gateway. &nbsp;The `ENTRYPOINT` command will ensure that the container does not exit immediately after starting. &nbsp;Also note the last two `jq` commands which will set the loop time for the simulated devices ... 2 second intervals will chew through your 8K free messages quickly when you can't figure out how to kill your container :-).<br /><br />```<br /># RUN<br />WORKDIR /usr/src/app/iot-edge/build<br /><br />## cat config file into env var<br />ENTRYPOINT J_FILE=$(cat /usr/src/app/iot-edge/samples/simulated_device_cloud_upload/src/simulated_device_cloud_upload_lin.json) \<br /><br />&nbsp; &nbsp; # cd into sample dir<br />&nbsp; &nbsp; &amp;&amp; cd /usr/src/app/iot-edge/samples/simulated_device_cloud_upload/src/ \<br /><br />&nbsp; &nbsp; # update settings based on env vars<br />&nbsp; &nbsp; &amp;&amp; echo "$J_FILE" \<br />&nbsp; &nbsp; #configure iot hub<br />&nbsp; &nbsp; | jq '.modules[0].args.IoTHubName="'$IoTHubName'"' \<br />&nbsp; &nbsp; | jq '.modules[0].args.IoTHubSuffix="'$IoTHubSuffix'"' \<br />&nbsp; &nbsp; | jq '.modules[0].args.Transport="AMQP"' \<br />&nbsp; &nbsp; # configure device 1<br />&nbsp; &nbsp; | jq '.modules[1].args[0].deviceId="'$device1'"' \<br />&nbsp; &nbsp; | jq '.modules[1].args[0].deviceKey="'$device1key'"' \<br />&nbsp; &nbsp; # configure device 2<br />&nbsp; &nbsp; | jq '.modules[1].args[1].deviceId="'$device2'"' \<br />&nbsp; &nbsp; | jq '.modules[1].args[1].deviceKey="'$device2key'"' \<br />&nbsp; &nbsp; # set device 1 message period<br />&nbsp; &nbsp; | jq '.modules[2].args.messagePeriod=10000' \<br />&nbsp; &nbsp; # set device 2 message period<br />&nbsp; &nbsp; | jq '.modules[3].args.messagePeriod=10000' \<br />&nbsp; &nbsp; &gt; replaced.json \<br /><br />&nbsp; &nbsp; # print updates<br />&nbsp; &nbsp; &amp;&amp; cat replaced.json \<br /><br />&nbsp; &nbsp; # cd back up to build dir<br />&nbsp; &nbsp; &amp;&amp; cd /usr/src/app/iot-edge/build/ \<br /><br />&nbsp; &nbsp; # run gateway<br />&nbsp; &nbsp; &amp;&amp; ./samples/simulated_device_cloud_upload/simulated_device_cloud_upload_sample ../samples/simulated_device_cloud_upload/src/replaced.json<br /><div><br /></div>```<br /><br />With the dockerfile scripted out, we can now create our complete image. &nbsp;From the previously opened elevated Powershell prompt issue the following command:<br /><br />`Get-Content .\Dockerfile.txt | docker build -t iot-edge -`<br /><br />This will read the dockerfile in and pass it to the Docker build command. &nbsp;Also not that the image will be tagged with 'iot-edge' for easy identification. &nbsp;This command will take about 10-15 to run initially, but subsequent runs should leveraging caching and be much faster.<br /><br />Now for the&nbsp;pièces de résistance!<br /><br />`docker run -ti iot-edge`<br /><br />The container will fire up, print out the json config file and begin sending telemetry data to Azure! &nbsp;Wait a few min and refresh the portal to see your simulated data arriving in IoT Hub from your fancy containerized IoT-Edge Gateway!<br /><br />The complete docker file can be found at <a href="https://gist.github.com/WilliamBerryiii/ee31a154d99130f9bbe472a320d49655">this gist</a>.<br /><br />Happy Coding!<br /><br /><br />