---
layout: post
title: Using UpGuard & Powershell Queries to Monitor your NIC Speed
date: '2016-01-07T14:20:00.001-08:00'
author: William Berry
tags:
- Powershell
- DevOps
- UpGuard
modified_time: '2016-01-28T09:41:49.052-08:00'
thumbnail: http://2.bp.blogspot.com/-G8_LRFAf7F0/Vo7ivMl7tmI/AAAAAAAAAcA/fMAmDdEjqOA/s72-c/NetworkAdapters.PNG
blogger_id: tag:blogger.com,1999:blog-4707687462195457004.post-3120196264169624405
blogger_orig_url: http://www.lucidmotions.net/2016/01/using-upguard-to-query-nic-speed.html
---

One of the sweetest features of UpGuard is the ability to add custom queries for node scans. &nbsp;Though the standard battery of queries that the product provides is very through and well selected, it does have some blind spots. &nbsp;Previously, I've written about using&nbsp;UpGuard&nbsp;to <a href="http://www.lucidmotions.net/2015/10/simple-disk-space-check-w-scriptrock.html">monitor Disk Space</a> on server drives and to <a href="http://www.lucidmotions.net/2015/12/scan-active-directory-users-groups-with-powershell.html">track changes to Active Directory</a>. &nbsp;In this post we are going to look at a more nefarious problem that we ran into lately and leverage&nbsp;UpGuard&nbsp;to help monitor for changes.<br /><div><br /></div><div>The other day, our ETL pump began to experience SQL connection timeouts with one of our database servers. &nbsp;As we dug deeper into the issue, we discovered that a primary NIC on that cluster node was running at 100% utilization and the jump to discover that the NIC had reset itself from its originally configured 1GB speed to 100MB, was short. &nbsp;Under normal loads this would not have posed much of an issue since most SQL connections are small payloads over short duration connections. In this case a large log shipping job was running in the background putting additional pressure on the pipe. &nbsp;</div><div><br /></div><div>Whether or not this issue had historical relevancy, which it does, I would still turn to&nbsp;UpGuard&nbsp;to at least get a&nbsp;daily heads up that something might be wrong. &nbsp;Since the NIC resets tend to occur after server restarts, I moved all our database machines to their own environment and set the scan time to kick off in the last minute of our standard maintenance window, increasing the chance that the daily scan would catch the drift. &nbsp;The last piece of the puzzle is the actual query...</div><div><br /></div><div>Since most all the Powershell to do this stuff has been written before I turned to Google for a little help. &nbsp;A simple query of 'Get NIC speed with Powershell' turned up <a href="http://stackoverflow.com/a/3002568/1276028">this StackOverflow answer</a> that has a great place to jump off from. The code simply gets all the network adapter data, filtering on a non-null speed and MAC address setting and then dumps four properties to a table, a'la</div><br /><script src="https://gist.github.com/WilliamBerryiii/bbcb2f2ad902c9f38cdd.js"></script> <br /><div>Unfortunately,&nbsp;UpGuard&nbsp;won't be too happy with the formatted table of results so we need to modify the script&nbsp;slightly to shape the data correctly. <br /><br /><script src="https://gist.github.com/WilliamBerryiii/f8e1ad9ef6fa15e42676.js"></script> Here we have simply replaced the call to 'Format-Table' with a 'Select-Object -Property' call with the same property list. <br /><br />The last step is to add this script to our custom query section and set a Key Name to NetConnectionID so that each eligible NIC is listed under it common name.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-G8_LRFAf7F0/Vo7ivMl7tmI/AAAAAAAAAcA/fMAmDdEjqOA/s1600/NetworkAdapters.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="156" src="http://2.bp.blogspot.com/-G8_LRFAf7F0/Vo7ivMl7tmI/AAAAAAAAAcA/fMAmDdEjqOA/s640/NetworkAdapters.PNG" width="640" /></a></div><br />With our query configured, our next scan will produce the output below.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-MZtqNEX6jW4/Vo7jJKgJj0I/AAAAAAAAAcI/d4x6k3NH3_I/s1600/NetworkAdapters2.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="80" src="http://4.bp.blogspot.com/-MZtqNEX6jW4/Vo7jJKgJj0I/AAAAAAAAAcI/d4x6k3NH3_I/s200/NetworkAdapters2.PNG" width="200" /></a></div><br /><br /><br /><br /><br /><br />With that we are done, Happy&nbsp;UpGuard'in&nbsp;!</div><div><br /><br />PS. &nbsp;I wanted to post a quick update to show the use of a calculated property for link speed. &nbsp;So here you go:<br /><br /><script src="https://gist.github.com/WilliamBerryiii/0ef15deda29d462b7f34.js"></script></div>