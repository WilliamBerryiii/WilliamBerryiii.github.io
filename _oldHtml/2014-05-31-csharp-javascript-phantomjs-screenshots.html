---
layout: post
title: Fun with C#, JavaScript & PhantomJS
date: '2014-05-31T14:40:00.001-07:00'
author: William Berry
tags:
- JavaScript
- C#
- PhantomJs
modified_time: '2014-06-01T13:25:13.862-07:00'
blogger_id: tag:blogger.com,1999:blog-4707687462195457004.post-6229064329590076049
blogger_orig_url: http://www.lucidmotions.net/2014/05/csharp-javascript-phantomjs-screenshots.html
---

I have a fun little project going on right now that involves taking a portion of a web page, loading it into PhantomJS, passing a lump of data to it, taking a picture of the page, and displaying that image in a RDLC report. &nbsp;There are like a ba'gillion different ways to accomplish this, so the below is a hacker's proof of concept.<br /><br /><div><div style="text-align: center;">***</div></div><div><br /></div><div>First up, we are going to need is a very simple web page with the following elements:<br /><ul><li>A form element with a hidden input "data" that will be used to move data from the primary application to the stub page.&nbsp;</li><li>Two more inputs "height" and "width", which are used simply to show command line argument passing to Phantom.</li><li>A button that can be used to trigger a JavaScript function that will in turn draw the page.</li></ul></div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #557799;">&lt;!DOCTYPE html&gt;</span><br /><span style="color: #007700;">&lt;html</span> <span style="color: #0000cc;">lang=</span><span style="background-color: #fff0f0;">"en"</span> <span style="color: #0000cc;">xmlns=</span><span style="background-color: #fff0f0;">"http://www.w3.org/1999/xhtml"</span><span style="color: #007700;">&gt;</span><br />    <span style="color: #007700;">&lt;head&gt;</span><br />        <span style="color: #007700;">&lt;meta</span> <span style="color: #0000cc;">charset=</span><span style="background-color: #fff0f0;">"utf-8"</span> <span style="color: #007700;">/&gt;</span><br />        <span style="color: #007700;">&lt;title&gt;</span>This is my test page<span style="color: #007700;">&lt;/title&gt;</span><br />        <span style="color: #007700;">&lt;script </span><span style="color: #0000cc;">src=</span><span style="background-color: #fff0f0;">"my.js"</span><span style="color: #007700;">&gt;&lt;/script&gt;</span><br />    <span style="color: #007700;">&lt;/head&gt;</span><br />    <span style="color: #007700;">&lt;body</span> <span style="color: #0000cc;">style=</span><span style="background-color: #fff0f0;">"background-color: white; color: black; font-size: 1em;"</span><span style="color: #007700;">&gt;</span><br />        <span style="color: #007700;">&lt;form&gt;</span><br />            <span style="color: #007700;">&lt;input</span> <span style="color: #0000cc;">id=</span><span style="background-color: #fff0f0;">"data"</span> <span style="color: #0000cc;">type=</span><span style="background-color: #fff0f0;">"hidden"</span> <span style="color: #0000cc;">name=</span><span style="background-color: #fff0f0;">"data"</span> <span style="color: #0000cc;">value=</span><span style="background-color: #fff0f0;">""</span><span style="color: #007700;">&gt;</span><br />            <span style="color: #007700;">&lt;input</span> <span style="color: #0000cc;">id=</span><span style="background-color: #fff0f0;">"height"</span> <span style="color: #0000cc;">type=</span><span style="background-color: #fff0f0;">"hidden"</span> <span style="color: #0000cc;">name=</span><span style="background-color: #fff0f0;">"height"</span> <span style="color: #0000cc;">value=</span><span style="background-color: #fff0f0;">""</span><span style="color: #007700;">&gt;</span><br />            <span style="color: #007700;">&lt;input</span> <span style="color: #0000cc;">id=</span><span style="background-color: #fff0f0;">"width"</span> <span style="color: #0000cc;">type=</span><span style="background-color: #fff0f0;">"hidden"</span> <span style="color: #0000cc;">name=</span><span style="background-color: #fff0f0;">"width"</span> <span style="color: #0000cc;">value=</span><span style="background-color: #fff0f0;">""</span><span style="color: #007700;">&gt;</span><br />            <span style="color: #007700;">&lt;button</span> <span style="color: #0000cc;">id=</span><span style="background-color: #fff0f0;">"buildFoo"</span> <span style="color: #0000cc;">name=</span><span style="background-color: #fff0f0;">"buildFoo"</span> <br />             <span style="color: #0000cc;">type=</span><span style="background-color: #fff0f0;">"button"</span> <span style="color: #0000cc;">value=</span><span style="background-color: #fff0f0;">"Submit"</span> <br />             <span style="color: #0000cc;">onclick=</span><span style="background-color: #fff0f0;">" init() "</span> <span style="color: #0000cc;">style=</span><span style="background-color: #fff0f0;">"visibility: hidden;"</span><span style="color: #007700;">&gt;</span><br />      <span style="color: #007700;">&lt;/button&gt;</span><br />        <span style="color: #007700;">&lt;/form&gt;</span><br />        <span style="color: #007700;">&lt;div</span> <span style="color: #0000cc;">class=</span><span style="background-color: #fff0f0;">"container"</span><span style="color: #007700;">&gt;</span><br />        <span style="color: #007700;">&lt;/div&gt;</span><br />    <span style="color: #007700;">&lt;/body&gt;</span><br /><span style="color: #007700;">&lt;/html&gt;</span><br /></pre></td></tr></tbody></table></div><div><br />Hopefully it's obvious that our Javascript method init() in my.js, will simply plunk everything in the "container" div for display.<br /><br /><div style="text-align: center;">***</div><br />The next element we need, moving up the stack, is our Javascript runner that we will pass to Phantom, kicking this whole process off. &nbsp;Make note of the filesystem call for <i>stumpage.html</i>; this could be passed in; but, I figured showing a filesystem call might be useful to someone.<br /><br /></div><div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41<br />42<br />43<br />44<br />45<br />46<br />47<br />48<br />49<br />50<br />51<br />52<br />53<br />54<br />55<br />56<br />57<br />58<br />59<br />60<br />61<br />62<br />63<br />64<br />65<br />66<br />67<br />68<br />69<br />70<br />71<br />72<br />73<br />74<br />75<br />76<br />77<br />78<br />79<br />80<br />81<br />82<br />83</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">var</span> system <span style="color: #333333;">=</span> require(<span style="background-color: #fff0f0;">'system'</span>);<br /><span style="color: #008800; font-weight: bold;">var</span> args <span style="color: #333333;">=</span> require(<span style="background-color: #fff0f0;">'system'</span>).args;<br /><span style="color: #008800; font-weight: bold;">var</span> fs <span style="color: #333333;">=</span> require(<span style="background-color: #fff0f0;">'fs'</span>);<br /><span style="color: #008800; font-weight: bold;">var</span> page <span style="color: #333333;">=</span> require(<span style="background-color: #fff0f0;">'webpage'</span>).create();<br /><br /><span style="color: #888888;">//args[0] is this javascript file.</span><br /><span style="color: #008800; font-weight: bold;">var</span> height <span style="color: #333333;">=</span> args[<span style="color: #0000dd; font-weight: bold;">1</span>];<br /><span style="color: #008800; font-weight: bold;">var</span> width <span style="color: #333333;">=</span> args[<span style="color: #0000dd; font-weight: bold;">2</span>];<br /><br /><span style="color: #008800; font-weight: bold;">var</span> address <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">"file:///"</span> <span style="color: #333333;">+</span> fs.workingDirectory <span style="color: #333333;">+</span> <span style="background-color: #fff0f0;">"/stubpage.html"</span>;<br /><span style="color: #008800; font-weight: bold;">var</span> data <span style="color: #333333;">=</span> system.stdin.readLine();<br /><br />page.open(address, <span style="color: #008800; font-weight: bold;">function</span>() {<br /><br /> page.zoomFactor <span style="color: #333333;">=</span> <span style="color: #0000dd; font-weight: bold;">1</span>;<br /> page.viewportSize <span style="color: #333333;">=</span> {<br />  width<span style="color: #333333;">:</span> width,<br />  height<span style="color: #333333;">:</span> height<br /> };<br /> page.evaluate(<span style="color: #008800; font-weight: bold;">function</span>(data, height, width) {<br />  <span style="color: #888888;">//add the "data" to our page</span><br />  <span style="color: #008800; font-weight: bold;">var</span> d <span style="color: #333333;">=</span> <span style="color: #007020;">document</span>.getElementById(<span style="background-color: #fff0f0;">'data'</span>);<br />  d.value <span style="color: #333333;">=</span> data;<br />  <span style="color: #888888;">//set the height input</span><br />  <span style="color: #008800; font-weight: bold;">var</span> h <span style="color: #333333;">=</span> <span style="color: #007020;">document</span>.getElementById(<span style="background-color: #fff0f0;">'height'</span>);<br />  h.value <span style="color: #333333;">=</span> height;<br />  <span style="color: #888888;">//set the width input</span><br />  <span style="color: #008800; font-weight: bold;">var</span> w <span style="color: #333333;">=</span> <span style="color: #007020;">document</span>.getElementById(<span style="background-color: #fff0f0;">'width'</span>);<br />  w.value <span style="color: #333333;">=</span> width;<br />  <span style="color: #888888;">//click the button to fire the page's JS</span><br />  <span style="color: #008800; font-weight: bold;">var</span> b <span style="color: #333333;">=</span> <span style="color: #007020;">document</span>.getElementById(<span style="background-color: #fff0f0;">"buildFoo"</span>);<br />  b.click();<br /> }, data, height, width);<br /><br /> waitFor(<span style="color: #008800; font-weight: bold;">function</span>() {<br />  <span style="color: #888888;">//something to wait on ...</span><br />  <span style="color: #008800; font-weight: bold;">return</span> page.evaluate(<span style="color: #008800; font-weight: bold;">function</span>() {<br />   <span style="color: #888888;">//do we ahve a foo element on the page yet?</span><br />   <span style="color: #008800; font-weight: bold;">if</span> (<span style="color: #007020;">document</span>.getElementById(<span style="background-color: #fff0f0;">'foo'</span>)) {<br />    <span style="color: #008800; font-weight: bold;">return</span> <span style="color: #008800; font-weight: bold;">true</span>;<br />   } <span style="color: #008800; font-weight: bold;">else</span> {<br />    <span style="color: #008800; font-weight: bold;">return</span> <span style="color: #008800; font-weight: bold;">false</span>;<br />   }<br />  });<br /> }, <span style="color: #008800; font-weight: bold;">function</span>() {<br />  <span style="color: #888888;">//take a picture, it lasts longer</span><br />  <span style="color: #008800; font-weight: bold;">var</span> base64Image <span style="color: #333333;">=</span> page.renderBase64(<span style="background-color: #fff0f0;">'PNG'</span>);<br />  <span style="color: #888888;">//write the image to stdout</span><br />  system.stdout.write(base64Image);<br />  <span style="color: #007020;">window</span>.phantom.exit();<br /> });<br />});<br /><br /><span style="color: #008800; font-weight: bold;">function</span> waitFor(testFx, onReady, timeOutMillis) {<br /> <span style="color: #888888;">// timeout after 10 sec.</span><br /> <span style="color: #008800; font-weight: bold;">var</span> maxtimeOutMillis <span style="color: #333333;">=</span> timeOutMillis <span style="color: #333333;">?</span> timeOutMillis <span style="color: #333333;">:</span> <span style="color: #0000dd; font-weight: bold;">10000</span>,<br />  start <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> <span style="color: #007020;">Date</span>().getTime(),<br />  condition <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">false</span>,<br />  interval <span style="color: #333333;">=</span> setInterval(<span style="color: #008800; font-weight: bold;">function</span>() {<br />   <span style="color: #008800; font-weight: bold;">if</span> ((<span style="color: #008800; font-weight: bold;">new</span> <span style="color: #007020;">Date</span>().getTime() <span style="color: #333333;">-</span> start <span style="color: #333333;">&lt;</span> maxtimeOutMillis) <br />    <span style="color: #333333;">&amp;&amp;</span> <span style="color: #333333;">!</span>condition) {<br />    <span style="color: #888888;">// If not time-out yet</span><br />    <span style="color: #888888;">// and condition not yet fulfilled</span><br />    condition <span style="color: #333333;">=</span> (<span style="color: #008800; font-weight: bold;">typeof</span>(testFx) <span style="color: #333333;">===</span> <span style="background-color: #fff0f0;">"string"</span> <br />     <span style="color: #333333;">?</span> <span style="color: #007020;">eval</span>(testFx) <br />     <span style="color: #333333;">:</span> testFx());<br />   } <span style="color: #008800; font-weight: bold;">else</span> {<br />    <span style="color: #008800; font-weight: bold;">if</span> (<span style="color: #333333;">!</span>condition) {<br />     <span style="color: #888888;">// If condition still not fulfilled </span><br />     <span style="color: #888888;">//(timeout but condition is 'false')</span><br />     phantom.exit(<span style="color: #0000dd; font-weight: bold;">1</span>);<br />    } <span style="color: #008800; font-weight: bold;">else</span> {<br />     <span style="color: #888888;">// Condition fulfilled </span><br />     <span style="color: #888888;">//(timeout and/or condition is 'true')</span><br />     <span style="color: #008800; font-weight: bold;">typeof</span>(onReady) <span style="color: #333333;">===</span> <span style="background-color: #fff0f0;">"string"</span> <br />     <span style="color: #333333;">?</span> <span style="color: #007020;">eval</span>(onReady) <br />     <span style="color: #333333;">:</span> onReady();<br />     <span style="color: #888888;">//&lt; Stop this interval</span><br />     clearInterval(interval); <br />    }<br />   }<br />  }, <span style="color: #0000dd; font-weight: bold;">250</span>); <span style="color: #888888;">// repeat check every 250ms</span><br />};<br /></pre></td></tr></tbody></table></div></div><br />There are quite a few things to note in this file: <br /><br />First, lines 7 &amp; 8 are pulling out command line args from the Phantom process startup, you will see the supplying of those args from C# in the next section. &nbsp;Then take note of the code on line 11 which reads out data blob off the stdin pipe (be sure to see the warning in the C# section below).<br /><br />The meat of the script is the <a href="http://phantomjs.org/api/webpage/method/open.html">page.open</a> call where Phantom will load up our html page. &nbsp;In this function we will set page attributes through the zoom factor and viewport properties. &nbsp;We then leverage the <a href="http://phantomjs.org/api/webpage/method/evaluate.html">page.evaluate</a> function to get our data, height and width values into the hidden inputs in our html page. &nbsp;And finally we find the hidden button and click it which will begin the process of drawing our page. <br /><br />Since the page drawing (rendering of an SVG image or the map) takes time, we must set up a polling routine that will wait until the page has been rendered before taking a screenshot. &nbsp;To set up the loop we are using a very nice little example from the Phantom codebase over at GitHub which can be found <a href="https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js" target="_blank">here</a>. &nbsp;The loop simply waits for a "foo" element to be present on the page then continues on to take the screen shot, write the bytes to stdout and then exit.<br /><br /><div style="text-align: center;">***</div><br />The last piece of the puzzle is starting Phantom in a process and getting our data across stdin to our JS runner above.<br /><br /><div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">static</span> <span style="color: #333399; font-weight: bold;">byte</span>[] <span style="color: #0066bb; font-weight: bold;">GetImage</span>(<br />                         IEnumerable&lt;Datum&gt; data,<br />                         <span style="color: #333399; font-weight: bold;">string</span> jsFile<br />                     )<br />{<br /><span style="color: #888888;">//Path to PhantomJS install, you can add to path, etc.</span><br /><span style="color: #008800; font-weight: bold;">const</span> <span style="color: #333399; font-weight: bold;">string</span> path = <span style="background-color: #fff0f0;">@"C:\Program Files\phantomjs-1.9.7\phantomjs.exe"</span>;<br /><span style="color: #888888;">//build command line args, Phantom Runner and height/width args</span><br /><span style="color: #333399; font-weight: bold;">var</span> args = <span style="color: #008800; font-weight: bold;">new</span> <span style="color: #333399; font-weight: bold;">object</span>[] { jsFile, <span style="color: #6600ee; font-weight: bold;">800</span>, <span style="color: #6600ee; font-weight: bold;">650</span> };<br /><span style="color: #888888;">//startup environment for Phantom</span><br /><span style="color: #333399; font-weight: bold;">var</span> info = <span style="color: #008800; font-weight: bold;">new</span> ProcessStartInfo(path, <span style="color: #333399; font-weight: bold;">string</span>.Join(<span style="background-color: #fff0f0;">" "</span>, args))<br />{<br />    RedirectStandardInput = <span style="color: #008800; font-weight: bold;">true</span>,<br />    RedirectStandardOutput = <span style="color: #008800; font-weight: bold;">true</span>,<br />    RedirectStandardError = <span style="color: #008800; font-weight: bold;">true</span>,<br />    UseShellExecute = <span style="color: #008800; font-weight: bold;">false</span>,<br />    CreateNoWindow = <span style="color: #008800; font-weight: bold;">true</span><br />};<br /><span style="color: #333399; font-weight: bold;">var</span> p = Process.Start(info);<br />p.Start();<br /><br /><span style="color: #888888;">//open stream, write serialized data, close</span><br /><span style="color: #333399; font-weight: bold;">var</span> streamwriter = p.StandardInput;<br />streamwriter.WriteLine(JsonConvert.SerializeObject(data.ToList()));<br />streamwriter.Close();<br /><br /><span style="color: #888888;">//listen on standard out and read until process exits.</span><br /><span style="color: #333399; font-weight: bold;">var</span> stdout = p.StandardOutput.ReadToEnd();<br />p.WaitForExit();<br /><br /><span style="color: #888888;">//return byte[] of image</span><br /><span style="color: #008800; font-weight: bold;">return</span> Convert.FromBase64String(stdout);<br />} <br /></pre></td></tr></tbody></table></div></div><br />We begin our C# method by setting up the path to Phantom (note: you could add Phantom to your path, pass it in so there are no magic consts, etc.). &nbsp;Next we need to set up the command line arguments for Phantom:<br /><br /><ul><li>The relative path to our JavaScript runner file from above.</li><li>The page height.</li><li>The page width. &nbsp;</li></ul><br />Continue by setting up a process environment for Phantom by redirecting Standard In, Out &amp; Error which will enable interaction with Phantom. &nbsp;The final two process settings are to prevent a window at process launch and the disabling of Shell Execution (see MSDN docs for details on <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.processstartinfo.useshellexecute.aspx">Shell Execution</a>)<br /><br />With Phantom up and running we can take a reference to the redirected standard input stream, serialize our data over to our Phantom process. &nbsp;Closing of the input stream will trigger page evaluation over in Phantom.<br /><br />***WARNING*** it should be noted that a read of stdin as of Phantom 1.9.7 is a blocking call. &nbsp;However, there is a feature request for 2.0 that will make this async by default. &nbsp;If you are utilizing this technique you will want to defensively block on the stdin read in the event that things change in the future.<br /><br />The final step is to snag the bytes from stdout making sure to call to WaitForExit method of the process happens after you take a reference to the stdout. &nbsp;The ordering will ensure that you read off all the contents of stdout. &nbsp;Lastly, convert the string to a byte array and return.<br /><br /><div style="text-align: center;">***</div><div style="text-align: center;"><br /></div><div style="text-align: left;">As I noted in the introduction, you could add your byte array to a dataset, then map an Image element of an RDLC to the dataset, giving you dynamic image content for reports. &nbsp;You could potentially use this technique in integration tests to ensure that the positions of elements on the page have not moved. &nbsp;Or even as a simple archiving technique to scrape and save the state of a website. &nbsp;</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Happy Hacking!</div>