---
layout: post
title: A CI Migration Part 1 - Jenkins, NAnt & Window's Authentication
date: '2013-12-05T22:35:00.001-08:00'
author: William Berry
tags:
- Automation
- NAnt
- Build Pipeline
- Continuous Integration
- Jenkins
- Window's Authentication
modified_time: '2013-12-06T01:04:17.159-08:00'
blogger_id: tag:blogger.com,1999:blog-4707687462195457004.post-5956522040264772246
blogger_orig_url: http://www.lucidmotions.net/2013/12/a-ci-migration-part-1-jenkins-nant.html
---

I am deep in the throws of a slow migration that is laying the groundwork for a continuous integration style build =&gt; unit test =&gt; deploy =&gt; integration test, pipeline. &nbsp;I have shaped Jenkins enough to get builds and unit tests to function smoothly; however, recompilation is still happening during the packaging step using an existing NAnt build system and not Jenkins.<br><div><br></div><div>Problem:</div><div>Get packaging step, scripts written in NAnt, to pull and use latest compiled artifacts from Jenkins.</div><div><br></div><div>Solution:</div><div>This process was pretty straight forward, until I got to the NAnt packaging scripts<br><br>In Jenkins under&nbsp;<i>Post Build Actions</i> for your job, select "Archive the Artifacts". &nbsp;Then in the <i>Files to archive</i> setting, I entered "package/**", as the final step of our NAnt build script neatly puts the compiled artifacts into a folder aptly named "package".<br><br>With the build job set up, fire off a build now and visit&nbsp;http://your.jenkins.server.com/job/JobName/lastSuccessfulBuild/artifact/*zip*/archive.zip in your browser. &nbsp;If all has gone well you will be downloading the zipped artifacts from the last successful build.<br><br>Armed with a functioning url, fire up the <a href="http://nant.sourceforge.net/release/0.91/help/tasks/get.html" target="_blank">NAnt docs</a>&nbsp;for reference and drop this little gem in your script to pull the archived artifacts:<br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br>&lt;get src="http://jenkins.server.com/job/JobName/lastSuccessfulBuild/artifact/*zip*/archive.zip" dest="{build.current.outputdir}" /&gt;</span></div><br>And ... Run.<br><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">BUILD FAILED<br><br>C:\Foo\Bar\default.build(48,10):<br>Unable to download 'http://your.jenkins.server.com/job/JobName/lastSuccessfulBuild/artifact/*zip*/archive.zip' to 'C:\your\working\dir\'. The remote server returned an error: (401) Unauthorized.</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br></span>Right, pesky authentication. <br><br><div style="text-align: center;">***</div><br>We need to get off track here for a moment to discuss some environmental details. &nbsp;Jenkins is highly configurable and is flexible enough to run in many environments. &nbsp;With the backdrop of Windows and and Active Directory I have currently opted for the following setup:<br><ul><li>Jenkins as Windows Service - instructions <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+as+a+Windows+service" target="_blank">here</a>.</li><li>IIS site that does url rewriting to forward requests to Jenkins via an inbound reverse proxy with Windows Authentication.</li></ul>"Why? Dear God, Why?" You ask.<br><br>Active Directory. <br><br>While I am sure some people posses the magically delicious lucky charms to make the Jenkins AD plug-in and their AD services play ball, I had no such luck. &nbsp;Plan B. &nbsp;Use Windows Authentication through a forwarding site in IIS to proxy authentication. &nbsp;This may seem ugly on the face of it; but, in an AD world this actually takes some of the pain out of configuring the whole environment - let the tools do the work.<br><br>The forwarding site is a snap to set up, relatively speaking:<br><ul><li>Bind Jenkins to Localhost on your favorite port - instructions <a href="https://wiki.jenkins-ci.org/display/JENKINS/Starting+and+Accessing+Jenkins">here</a></li><li>Build new site in IIS</li><li>Disable all authentication except Windows Authentication</li><li>Enable URL Rewriting</li><li>Add inbound reverse proxy rule to rewrite jenkins.yourdomain.com to the localhost address for Jenkins.</li><li>Create an AD GPO for your engineers to allow access to jenkins.yourdomain.com (you likely need to do this because the nice address will not be implicitly trusted by browsers as being part of the local domain)</li><li>Set up logging in IIS</li><li>Set up log rotation/deletion using the Task Scheduler</li><ul><li>&nbsp;You can use a simple PowerShell script along these lines to do the heavy lifting:</li></ul></ul><div><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">get-childitem -Path C:\inet\logfile\path -recurse |&nbsp;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">where-object {$_.lastwritetime -lt (get-date).addDays(-N)} |&nbsp;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">Foreach-Object { del $_.FullName } get-childitem -Path C:\inet\logfile\path\service |&nbsp;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">where-object {$_.lastwritetime -lt (get-date).addDays(-N)} |&nbsp;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">Foreach-Object { del $_.FullName }</span><span style="font-family: monospace, 'Courier New', Courier; font-size: xx-small;">**</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br></span><span style="font-family: monospace, 'Courier New', Courier; font-size: xx-small;">**Loose reference from <a href="http://stackoverflow.com/questions/17707757/powershell-to-output-folder-based-on-content-lastwritetime" target="_blank">here</a></span><br><br>You may want to archive these logs rather than plainly deleting them depending on your security and bookkeeping needs. &nbsp;Be aware that the log files will fill quickly with devs using Chrome notifiers, etc. &nbsp;For Chrome, I use <a href="https://chrome.google.com/webstore/detail/buildreactor/agfdekbncfakhgofmaacjfkpbhjhpjmp?hl=en">Build Reactor</a>&nbsp;and <a href="https://chrome.google.com/webstore/detail/hudson-monitor/lnalnbkkohdcnaapeeceifjabgmdfgah?hl=en">Hudson Monitor</a>, where Build Reactor monitors all active jobs on the server an Hudson Monitor covers my personal jobs.<br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br></span></div>At this point your engineers can access Jenkins from their browser with built in authentication and IT gets to centralize access control through AD ... Win-Win in my book!<br><br><div style="text-align: center;">***</div><br>And here we are, back at our original problem where the NAnt script cannot authenticate to Jenkins through IIS. &nbsp;There are a few options at this juncture:<br><ul><li>Simply embed authentication in the get nAnt task - not much more to say than "ewww"</li><li>Little bit of C# embedded in a nAnt script - this ought to get the job done nicely.</li></ul><div>Begin by building up a new target to hold our embedded script and add some error handling:</div><div><br></div><div><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&lt;target name="utility.getartifacts"&gt;</span></div><div><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;fail message="util.getartifacts requires the outputdir property to be set." unless="${property::exists('outputdir')}" /&gt;</span></div><div><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">...</span></div><br>Next we need a<span style="font-family: 'Helvetica Neue Light', HelveticaNeue-Light, helvetica, arial, sans-serif;">&nbsp;script tag and the relevant references and imports for our work. &nbsp;Since we need to make a network request for our compiled artifacts and save them locally to disk we will want the System DLL and bring in the Net and IO namespaces.</span><div><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&lt;script language="C#" prefix="resource" &gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;references&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;include name="System.dll" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/references&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;imports&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;import namespace="System.Net" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;import namespace="System.IO" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/imports&gt;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br></span>The core work of our script will be to build a WebClient and write the output of a download call to our output file location. &nbsp;The work of setting up windows authentication for our WebClient is done through <i>UseDefaultCredentials = true</i>. &nbsp;What we are gaining here is the ability for the user running our packaging script to have their credentials auto-negotiated by the WebClient.<br><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &lt;code&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp;  &lt;![CDATA[<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [TaskName("get_artifacts")]<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; public class ArtifactTask : Task {<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [TaskAttribute("resourceUrl", Required=true)]</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [StringValidator(AllowEmpty = false)]<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; public string ResourceUrl{ get; set; }</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [TaskAttribute("outputFile", Required=true)]</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [StringValidator(</span><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">AllowEmpty = false</span><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">)]</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; public string OutputFile{ get; set; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; public void GetArtifacts()<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WebClient &nbsp;client = new WebClient();<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client.UseDefaultCredentials = true;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client.Headers["User-Agent"] =<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Mozilla/4.0 (Compatible; Windows NT 5.1; MSIE 6.0) " +<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "(compatible; MSIE 6.0; Windows NT 5.1; " +<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ".NET CLR 1.1.4322; .NET CLR 2.0.50727)";<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Download data.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; File.WriteAllBytes(OutputFile,</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client.DownloadData(ResourceUrl));<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; protected override void ExecuteTask() {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetArtifacts();<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; ]]&gt;<br>&nbsp; &nbsp; &lt;/code&gt;</span><br><span 14px="" courier="" font-size:="" monospace="" new="" ourier=""><br></span>Most of the preceding code is self explanatory; a few attributes to do some validation, an override and our meat and potatoes method GetArtifacts.<br><br>The final step is to put everything together into 5 simple calls: build an output directory, make a reference to the output file, download the zip of the artifacts, unzip the artifacts, and delete the zip to clean things up.<br><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;mkdir dir="${build.current.outputdir}" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &lt;property name="build.current.artifacts" value="${project::get-base- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; directory()}\${build.current.outputdir}\archive.zip" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &lt;get_artifacts&nbsp;resourceUrl="</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">http://your.jenkins.server.com/job/JobName/lastSuccessfulBuild/artifact/*zip*/archive.zip" outputFile="C:\your\working\dir\</span><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">archive.zip</span><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">" /&gt;</span><br><span style="font-family: monospace, 'Courier New', Courier; font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &lt;unzip zipfile="${build.current.artifacts}" /&gt;<br>&nbsp; &nbsp; &nbsp; &nbsp; &lt;delete file="${build.current.artifacts}" /&gt;</span><br><br>This is just the first in a series of posts where I will try to record my path to CI. &nbsp;I cannot by any means say that this is the right way to do it; but, it is "a" way to do it. &nbsp;Feel free to rail on this in the comments below … we can all learn from an open discussion. &nbsp;I suppose the most important notes to take away are as follows:<br><br><ul><li>You need to be doing Continuous Integration/Automated Builds - "everyone" can't be wrong.</li><li>Don't try to do it all in one go - the risk is just too high and disruptions in the build environment can ripple across an organization.</li><li>Don't try to do it all in one go - your Devs will hate you for a massive process change.</li><li>Don't make anyone's life harder - we are automating here, so the users lives should get easier, no matter what. &nbsp;This may mean you have to sacrifice the easy and straight forward path for a convoluted hack-fest, just to get the ball rolling.</li><li>Momentum is powerful - once you show everyone that this stuff is useful they will be inspired and might even help the effort. &nbsp;No matter what, you won't be making things worse.&nbsp;</li><li>Share your stories - everyone is yelling from the hills that you need to be doing CI; but few have been honest and open about how they are actually getting it done.</li><li>Don't be a hero - realize that change takes time. &nbsp;You want process to evolve organically … revolution will just piss everyone off.</li></ul><div><br></div></div>