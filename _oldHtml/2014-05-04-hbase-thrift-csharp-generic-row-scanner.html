---
layout: post
title: HBase, Thrift, & C# - First Scanner and Leveraging Generics
date: '2014-05-04T15:50:00.001-07:00'
author: William Berry
tags:
- Scanners
- HBase
- Thrift
- Generics
- Type Constraints
- C# NoSql
modified_time: '2014-05-17T23:38:55.705-07:00'
blogger_id: tag:blogger.com,1999:blog-4707687462195457004.post-7024642767860289349
blogger_orig_url: http://www.lucidmotions.net/2014/05/hbase-thrift-csharp-generic-row-scanner.html
---

Continuing the epic series on Hbase, Thrift and C#, is this installment where we will review building our first row scanner by leveraging inheritance and generics to provide a broad based solution. &nbsp;If you have not done so please check out the other parts of the series:<br /><br />Part 1 -&nbsp;<a class="GCUXF0KCPB" href="http://www.lucidmotions.net/2014/04/nuget-code-generation-jenkins-thrift-hbase.html" style="border: 0px; color: #1155cc; display: inline-block; font-family: Arial, Helvetica, sans-serif; font-size: 13px; margin: 0px 10px 0px 0px; max-width: 100%; overflow: hidden; padding: 0px; text-decoration: none; text-overflow: ellipsis; vertical-align: baseline; white-space: nowrap; width: auto;">NuGet Servers, HBase, Thrift Code Generation and one sweet Jenkins CI Build</a><br />Part 2 -&nbsp;<a class="GCUXF0KCPB" href="http://www.lucidmotions.net/2014/05/hbase-thrift-csharp-first-connections.html" style="border: 0px; color: #1155cc; display: inline-block; font-family: Arial, Helvetica, sans-serif; font-size: 13px; margin: 0px 10px 0px 0px; max-width: 100%; overflow: hidden; padding: 0px; text-decoration: none; text-overflow: ellipsis; vertical-align: baseline; white-space: nowrap; width: auto;">HBase, Thrift &amp; C# - First Connections</a><br />Part 3 -&nbsp;<a class="GCUXF0KCPB" href="http://www.lucidmotions.net/2014/05/hbase-thrift-csharp-session-management.html" style="border: 0px; color: #1155cc; display: inline-block; font-family: Arial, Helvetica, sans-serif; font-size: 13px; margin: 0px 10px 0px 0px; max-width: 100%; overflow: hidden; padding: 0px; text-decoration: none; text-overflow: ellipsis; vertical-align: baseline; white-space: nowrap; width: auto;">HBase, Thrift, &amp; C# - Managing Sessions</a><br />Part 4 -&nbsp;<a href="http://www.lucidmotions.net/2014/05/hbase-thrift-csharp-generic-row-scanner.html" style="border: 0px; color: #1155cc; display: inline-block; font-family: Arial, Helvetica, sans-serif; font-size: 13px; margin: 0px 10px 0px 0px; max-width: 100%; overflow: hidden; padding: 0px; text-decoration: none; text-overflow: ellipsis; vertical-align: baseline; white-space: nowrap; width: auto;" target="_blank">HBase, Thrift, &amp; C# - First Scanner and Leveraging Generics</a><br /><br /><div style="text-align: center;">***</div><div style="text-align: center;"><br /></div>Hopefully you are somewhat familiar with the concepts of No-SQL and the various sub-database types. &nbsp;If not, I highly recommend spending an hour with Martin Folwer's - <a href="https://www.youtube.com/watch?v=qI_g07C_Q5I" target="_blank">Introduction To No-SQL</a>&nbsp;over on YouTube. &nbsp;It's an incredibly insightful skim of the No-Sql space.<br /><br />The Apache HBase project is a kin to the Cassandra project in that they are both databases oriented in the Column-Family store approach. &nbsp;I am not enough of an expert on the topic to provide deep details, so I will leave you to your wits and Google to fill in any missing pieces.<br /><br />Assuming you have some data in your working HBase cluster, I know ... it's a hell of an assumption; but go with me on this, we will need some way to get at that data. &nbsp;For now, we will simply focus on retreiving the data from the database and leave writing data for later in the series.<br /><br />The example query we will work with is the scan. &nbsp; Specifically, a prefix scan that will return all rows where the supplied identifier is matched against row key prefixes.<br /><br />We will begin by building the shell of a scanner class. &nbsp;It needs a few properties, such as the target table name, the columns we want to retrieve and a reference to the client we built back in <a href="https://www.blogger.com/blogger.g?blogID=4707687462195457004#editor/target=post;postID=5568222696367618036;onPublishedMenu=posts;onClosedMenu=posts;postNum=2;src=postname" target="_blank">part II</a>.<br /><br /><div><pre><span style="color: teal;">  1</span> <span style="color: blue;">public</span> <span style="color: blue;">class</span> Scanner<br /><span style="color: teal;">  2</span> { <br /><span style="color: teal;">  3</span>     <span style="color: blue;">public</span> <span style="color: blue;">string</span> TableName { <span style="color: blue;">get</span>; <span style="color: blue;">protected</span> <span style="color: blue;">set</span>; }<br /><span style="color: teal;">  4</span>     <span style="color: blue;">public</span> <span style="color: blue;">string</span>[] Columns { <span style="color: blue;">get</span>; <span style="color: blue;">protected</span> <span style="color: blue;">set</span>; }<br /><span style="color: teal;">  5</span>     <span style="color: blue;">public</span> Hbase.Client HBaseClient { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><span style="color: teal;">  6</span>  <br /><span style="color: teal;">  7</span>     <span style="color: blue;">protected</span> Scanner() <br /><span style="color: teal;">  8</span>     { <br /><span style="color: teal;">  9</span>  <br /><span style="color: teal;"> 10</span>     } <br /><span style="color: teal;"> 11</span> }</pre></div><br />With our class shell written, let's dig into our first public method. &nbsp;The method will take in a row key prefix as a parameter and will return a List&lt;T&gt;, where T is a model of our the underlaying HBase entity, let's call it "Foo". &nbsp;Additionally, we should tease out a private method that will iterate across the scanners results, yielding an IEnumerable&lt;Foo&gt;, which we can return as a list to the source caller.<br /><br /><div><pre><pre><span style="color: teal;">  1</span> <span style="color: blue;">public</span> List&lt;Foo&gt; SelectWithPrefixScanner(<span style="color: blue;">string</span> identifier)<br /><span style="color: teal;">  2</span> {  <br /><span style="color: teal;">  3</span>      var col = <span style="color: blue;">new</span> List&lt;<span style="color: blue;">byte</span>[]&gt;();  <br /><span style="color: teal;">  4</span>      col.AddRange(Columns.Select(StaticHelpers.GetBytes));  <br /><span style="color: teal;">  5</span>     <br /><span style="color: teal;">  6</span>      var scanner = HBaseClient.scannerOpenWithPrefix(  <br /><span style="color: teal;">  7</span>             TableName.GetBytes(),  <br /><span style="color: teal;">  8</span>             identifier.GetBytes(),  <br /><span style="color: teal;">  9</span>             col,  <br /><span style="color: teal;"> 10</span>             <span style="color: blue;">new</span> Dictionary&lt;<span style="color: blue;">byte</span>[], <span style="color: blue;">byte</span>[]&gt;()  <br /><span style="color: teal;"> 11</span>         );  <br /><span style="color: teal;"> 12</span>     <br /><span style="color: teal;"> 13</span>      <span style="color: blue;">return</span> GetAllRows&lt;Foo&gt;(scanner).ToList();  <br /><span style="color: teal;"> 14</span> } <br /><span style="color: teal;"> 15</span>  <br /><span style="color: teal;"> 16</span> <span style="color: blue;">private</span> IEnumerable&lt;Foo&gt; GetAllRows(<span style="color: blue;">int</span> scanner)<br /><span style="color: teal;"> 17</span> { <br /><span style="color: teal;"> 18</span>      <span style="color: blue;">while</span> (<span style="color: maroon;">true</span>)<br /><span style="color: teal;"> 19</span>      { <br /><span style="color: teal;"> 20</span>           var scannerResult = HBaseClient.scannerGet(scanner); <br /><span style="color: teal;"> 21</span>           <span style="color: blue;">if</span> (scannerResult.Count &gt; <span style="color: maroon;">0</span>)<br /><span style="color: teal;"> 22</span>           { <br /><span style="color: teal;"> 23</span>                var foo = <span style="color: blue;">new</span> Foo() <br /><span style="color: teal;"> 24</span>                { <br /><span style="color: teal;"> 25</span>                    Identifier = scannerResult.First().Row.GetString(), <br /><span style="color: teal;"> 26</span>                    Data = scannerResult.First().Columns <br /><span style="color: teal;"> 27</span>                }; <br /><span style="color: teal;"> 28</span>   <br /><span style="color: teal;"> 29</span>                <span style="color: green;">// Take data object and run container's parser over it.</span> <br /><span style="color: teal;"> 30</span>                foo.ParseFields(); <br /><span style="color: teal;"> 31</span>   <br /><span style="color: teal;"> 32</span>                <span style="color: blue;">yield</span> <span style="color: blue;">return</span> foo;<br /><span style="color: teal;"> 33</span>            } <br /><span style="color: teal;"> 34</span>            <span style="color: blue;">else</span> <br /><span style="color: teal;"> 35</span>            { <br /><span style="color: teal;"> 36</span>                HBaseClient.scannerClose(scanner); <br /><span style="color: teal;"> 37</span>                <span style="color: blue;">yield</span> <span style="color: blue;">break</span>;<br /><span style="color: teal;"> 38</span>             } <br /><span style="color: teal;"> 39</span>       } <br /><span style="color: teal;"> 40</span> }</pre></pre></div>In the SelectWithPrefixScanner method, we begin by building a list of columns that we will want the scanner to retrieve for us. &nbsp;The columns property could be set up with something as simple as:<br /><br /><div><pre><span style="color: teal;">  1</span> Columns = <span style="color: blue;">new</span>[] { <span style="color: maroon;">"c:v"</span> };</pre></div><br />where "c" is the column family in the rows to be queried and "v" is the specific column. &nbsp;Using a Linq Select(), the columns are passed to an extension method that will convert the strings into byte arrays adding the result to the "col" variable.<br /><br />Next, we set up the scanner using the HBase Client's scannerOpenWithPrefix method. &nbsp;As I noted before, the prefix scanner will select all rows where the row key begins with the identifier we are passing in. &nbsp;This method also requires a table name as bytes, the prefix identifier as bytes, our previously defined columns and a dictionary of attributes. <br /><br /><i>Moment of Honesty: &nbsp;I have no clue what the available attributes are that can go in the scanner. &nbsp;I could crack open the HBase Thrift implementation and find out but have not done so to date. &nbsp;I have searched Google a'plenty, and my results have always yielded squat. &nbsp;So, yeah.</i><br /><br />Continuing, the call to HBaseClient.scannerOpenWithPrefix() will return an Int identifier which uniquely identifies the remote scanner we instantiated. The scanners identifier is passed to the private method which will do the heavy lifting to fetch the results.<br /><br />The GetAllRows() method is a simple while loop that yields the results of the Client's scannerGet() method. &nbsp;As long as there are more results available, the method will build "Foo"s, using object initializer syntax to populate stock fields, and subsequently call a method on Foo to have the data parsed into fields/properties. <br /><br />And that's it. &nbsp;More or less straight forward; but, we are not done quite yet. &nbsp;Suppose for the sake of argument that we want to implement this scanner for not only type "Foo", but also type "Bar". &nbsp;Generics should do nicely.<br /><br />Step one to making this a generic set-up, is to define a common entity interface. &nbsp;Let's call that IHBaseEntity, and make it looks something like:<br /><br /><div><pre><span style="color: teal;">  1</span> <span style="color: blue;">public</span> <span style="color: blue;">interface</span> IHBaseEntity<br /><span style="color: teal;">  2</span> { <br /><span style="color: teal;">  3</span>     <span style="color: blue;">string</span> Identifier { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }<br /><span style="color: teal;">  4</span>     Dictionary&lt;<span style="color: blue;">byte</span>[], Hbase.TCell&gt; Data { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; };<br /><span style="color: teal;">  5</span>  <br /><span style="color: teal;">  6</span>     <span style="color: blue;">void</span> ParseFields(); <br /><span style="color: teal;">  7</span> }</pre></div><br />All "Foo" and "Bar" need to do is implement the interface by providing the two properties and a void method that can take <i>Data</i> and parse it into the respective entities own properties/fields.<br /><br />The next thing we need to do is get the SelectWithPrefixScanner to work with generic types. &nbsp;We will update the method signature to use type 'T, add type constraints to indicate that we are new'ing objects of type 'T and that the new'ed objects must implement the IHBaseEntity interface.<br /><br /><div><pre><span style="color: teal;">  1</span> <span style="color: blue;">public</span> List&lt;T&gt; SelectWithPrefixScanner&lt;T&gt;(<span style="color: blue;">string</span> identifier) where T : IHBaseEntity, <span style="color: blue;">new</span>() <br /><span style="color: teal;">  2</span> { <br /><span style="color: teal;">  3</span>    var col = <span style="color: blue;">new</span> List&lt;<span style="color: blue;">byte</span>[]&gt;(); <br /><span style="color: teal;">  4</span>    col.AddRange(Columns.Select(StaticHelpers.GetBytes)); <br /><span style="color: teal;">  5</span>  <br /><span style="color: teal;">  6</span>    var scanner = HBaseClient.scannerOpenWithPrefix( <br /><span style="color: teal;">  7</span>             tableName.GetBytes(), <br /><span style="color: teal;">  8</span>             identifier.GetBytes(), <br /><span style="color: teal;">  9</span>             col, <br /><span style="color: teal;"> 10</span>             <span style="color: blue;">new</span> Dictionary&lt;<span style="color: blue;">byte</span>[], <span style="color: blue;">byte</span>[]&gt;() <br /><span style="color: teal;"> 11</span>         ); <br /><span style="color: teal;"> 12</span>   <br /><span style="color: teal;"> 13</span>     <span style="color: blue;">return</span> GetAllRows&lt;T&gt;(scanner).ToList(); <br /><span style="color: teal;"> 14</span> }</pre></div><br />Because our return type has been updated from List&lt;Foo&gt; to List&lt;T&gt; we will need to make similar modifications to the GetAllRows method:<br /><br /><div><pre><span style="color: teal;">  1</span> <span style="color: blue;">private</span> IEnumerable&lt;T&gt; GetAllRows&lt;T&gt;(<span style="color: blue;">int</span> scanner) where T : IHBaseEntity, <span style="color: blue;">new</span>() <br /><span style="color: teal;">  2</span> { <br /><span style="color: teal;">  3</span>     <span style="color: blue;">while</span> (<span style="color: maroon;">true</span>)<br /><span style="color: teal;">  4</span>     { <br /><span style="color: teal;">  5</span>         var scannerResult = HBaseClient.scannerGet(scanner); <br /><span style="color: teal;">  6</span>         <span style="color: blue;">if</span> (scannerResult.Count &gt; <span style="color: maroon;">0</span>)<br /><span style="color: teal;">  7</span>         { <br /><span style="color: teal;">  8</span>             var obj = <span style="color: blue;">new</span> T() <br /><span style="color: teal;">  9</span>             { <br /><span style="color: teal;"> 10</span>                  Identifier = scannerResult.First().Row.GetString(), <br /><span style="color: teal;"> 11</span>                  Data = scannerResult.First().Columns <br /><span style="color: teal;"> 12</span>              }; <br /><span style="color: teal;"> 13</span>   <br /><span style="color: teal;"> 14</span>              <span style="color: green;">// Take data object and run container's parser over it.</span> <br /><span style="color: teal;"> 15</span>              obj.ParseFields(); <br /><span style="color: teal;"> 16</span>   <br /><span style="color: teal;"> 17</span>              <span style="color: blue;">yield</span> <span style="color: blue;">return</span> obj;<br /><span style="color: teal;"> 18</span>          } <br /><span style="color: teal;"> 19</span>          <span style="color: blue;">else</span> <br /><span style="color: teal;"> 20</span>          { <br /><span style="color: teal;"> 21</span>               HBaseClient.scannerClose(scanner); <br /><span style="color: teal;"> 22</span>               <span style="color: blue;">yield</span> <span style="color: blue;">break</span>;<br /><span style="color: teal;"> 23</span>          } <br /><span style="color: teal;"> 24</span>      } <br /><span style="color: teal;"> 25</span> }</pre></div><br />Update with the same constraints, build new objects of type 'T instead of Foo. &nbsp;Since we added the IHBaseEntity interface, we do not need to adjust the setting of Identifier and Data or the call to ParseFields. <br /><br />Lastly, implementing a custom scanner can now be as simple as setting properties for the specific table and columns that you want to query:<br /><br /><div><pre><span style="color: teal;">  1</span> <span style="color: blue;">public</span> <span style="color: blue;">class</span> MyCustomScanner : IScanner<br /><span style="color: teal;">  2</span> { <br /><span style="color: teal;">  3</span>     <span style="color: blue;">public</span> MyCustomScanner() <br /><span style="color: teal;">  4</span>         : <span style="color: blue;">base</span>() <br /><span style="color: teal;">  5</span>     { <br /><span style="color: teal;">  6</span>         TableName = <span style="color: maroon;">"my_table_name"</span>; <br /><span style="color: teal;">  7</span>         Columns = <span style="color: blue;">new</span>[] { <span style="color: maroon;">"c:v"</span> }; <br /><span style="color: teal;">  8</span>     } <br /><span style="color: teal;">  9</span> }</pre></div><br />Through the use of generics, we have been able to make a base scanner that can work for any entity implementing the IHBaseEntity interface. &nbsp;In the next part of the series we will investigate working with the entities and implementing the ParseFields() method. &nbsp;As always, questions and comments are welcomed!<br /><br /><br />